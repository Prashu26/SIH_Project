services:
  # MongoDB Service
  mongo:
    image: mongo:latest
    container_name: mongo
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
    networks:
      - mern-network

  # Backend Service
  backend:
    build: ./backend
    container_name: backend
    ports:
      - "8081:8080"
    environment:
      - MONGODB_URI=${MONGODB_URI:-mongodb://mongo:27017/mernapp}
      - PORT=${PORT:-8080}
      - PROVIDER_URL=http://blockchain:8545
      - IPFS_API_URL=http://ipfs:5001
      - POLYGON_RPC_URL=${POLYGON_RPC_URL:-https://rpc-mumbai.maticvigil.com}
      - PRIVATE_KEY=${PRIVATE_KEY:-}
      - CONTRACT_ADDRESS=${CONTRACT_ADDRESS:-}
      - JWT_SECRET=${JWT_SECRET:-}
      - NODE_ENV=${NODE_ENV:-development}
    env_file:
      - .env
    depends_on:
      - mongo
      - blockchain-deployer
    networks:
      - mern-network
    volumes:
      - blockchain-shared:/usr/src/app/blockchain
    restart: unless-stopped

  # Frontend Service
  frontend:
    build: ./frontend
    container_name: frontend
    ports:
      - "3000:80"
    depends_on:
      - backend
    networks:
      - mern-network
    restart: unless-stopped

  # Hardhat local blockchain node
  blockchain:
    build: ./backend/blockchain
    container_name: blockchain
    command: ["npm", "run", "node"]
    ports:
      - "8545:8545"
    networks:
      - mern-network
    volumes:
      - blockchain-shared:/app
    restart: unless-stopped

  # Deploys the smart contract to the blockchain node
  blockchain-deployer:
    build: ./backend/blockchain
    container_name: blockchain-deployer
    environment:
      - PROVIDER_URL=http://blockchain:8545
      - POLYGON_RPC_URL=${POLYGON_RPC_URL:-https://rpc-mumbai.maticvigil.com}
      - PRIVATE_KEY=${PRIVATE_KEY:-}
    env_file:
      - .env
    depends_on:
      - blockchain
    networks:
      - mern-network
    volumes:
      - blockchain-shared:/app
    command: ["npm", "run", "deploy"]
    restart: "no"

  # Local IPFS node (optional but used by backend IPFS service)
  ipfs:
    image: ipfs/kubo:latest
    container_name: ipfs
    ports:
      - "4001:4001" # swarm
      - "5001:5001" # API
      - "8080:8080" # gateway
    networks:
      - mern-network
    volumes:
      - ipfs-data:/data/ipfs
    restart: unless-stopped

# Networks
networks:
  mern-network:
    driver: bridge

# Volumes
volumes:
  mongo-data:
  blockchain-shared:
  ipfs-data:
